# =============================================================================
# CONFIGURAZIONE NGINX PER SYMFONY - BalanceBite
# =============================================================================

server {
    # -------------------------------------------------------------------------
    # LISTENER
    # -------------------------------------------------------------------------
    # Ascolta su porta 80 (HTTP) all'interno del container
    # Docker mapperà questa porta all'esterno (es. 8080:80)
    listen 80;
    
    # Nome del server (localhost per sviluppo)
    server_name localhost;

    # -------------------------------------------------------------------------
    # DOCUMENT ROOT
    # -------------------------------------------------------------------------
    # Symfony serve SOLO dalla cartella /public
    # index.php è l'unico entry point (front controller pattern)
    root /var/www/html/public;

    # -------------------------------------------------------------------------
    # LOCATION PRINCIPALE
    # -------------------------------------------------------------------------
    # Gestisce tutte le richieste
    location / {
        # try_files tenta in ordine:
        # 1. $uri = il file richiesto esiste? (es. /css/style.css)
        # 2. /index.php$is_args$args = altrimenti passa tutto a index.php
        #    $is_args = "?" se ci sono parametri, vuoto altrimenti
        #    $args = i parametri query string
        try_files $uri /index.php$is_args$args;
    }

    # -------------------------------------------------------------------------
    # GESTIONE PHP
    # -------------------------------------------------------------------------
    # Questa location cattura SOLO index.php
    # ~ = regex, ^/index\.php(/|$) = inizia con /index.php seguito da / o fine
    location ~ ^/index\.php(/|$) {
        # Passa la richiesta a PHP-FPM
        # "php" è il nome del servizio Docker, porta 9000
        fastcgi_pass php:9000;
        
        # Separa lo script PHP dal PATH_INFO
        # Es: /index.php/api/users → SCRIPT=/index.php, PATH_INFO=/api/users
        fastcgi_split_path_info ^(.+\.php)(/.*)$;
        
        # Include parametri FastCGI standard
        include fastcgi_params;
        
        # Variabili necessarie per PHP
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        fastcgi_param DOCUMENT_ROOT $realpath_root;
        
        # IMPORTANTE: "internal" significa che questa location
        # può essere raggiunta SOLO tramite redirect interno (try_files)
        # Non direttamente dall'esterno → sicurezza
        internal;
    }

    # -------------------------------------------------------------------------
    # BLOCCA ALTRI FILE PHP
    # -------------------------------------------------------------------------
    # Qualsiasi altro .php che non sia index.php → 404
    # Sicurezza: impedisce accesso a file PHP di vendor, config, etc.
    location ~ \.php$ {
        return 404;
    }

    # -------------------------------------------------------------------------
    # LOG
    # -------------------------------------------------------------------------
    error_log /var/log/nginx/error.log;
    access_log /var/log/nginx/access.log;
}
